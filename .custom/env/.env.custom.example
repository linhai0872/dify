# ==============================================================================
# 二开环境变量模板
# ==============================================================================
#
# 使用说明:
#   1. 复制此文件为对应环境的配置文件:
#      - .env.custom.dev  (开发环境)
#      - .env.custom.test (测试环境)
#      - .env.custom.prod (生产环境)
#
#   2. 根据实际环境修改配置值
#
#   3. 初始化命令:
#      make -f Makefile.custom env-init ENV=dev|test|prod
#
# ==============================================================================

# ------------------------------------------------------------------------------
# 功能开关
# ------------------------------------------------------------------------------
# 格式: DIFY_CUSTOM_<FEATURE>_ENABLED=true|false
# 说明: 所有二开功能统一使用此前缀，便于识别和管理

# 追踪搜索功能 (默认开启)
# 启用后可通过 X-Trace-Id 或 inputs.dify_trace_id 传入追踪 ID
# 并通过 /custom/apps/<app_id>/trace/<trace_id> API 查询执行详情
DIFY_CUSTOM_TRACE_SEARCH_ENABLED=true

# 原生文档提取器 (默认开启)
# 启用后支持 DOC/PPT/PPTX/EPUB 格式在默认 ETL 模式下提取
# PPTX/EPUB: 纯 Python 实现，无需外部依赖
# DOC/PPT: 需要 LibreOffice，使用自定义 API 镜像
DIFY_CUSTOM_NATIVE_EXTRACTORS_ENABLED=true

# 多租户功能
# DIFY_CUSTOM_MULTITENANCY_ENABLED=false

# 审计日志功能
# DIFY_CUSTOM_AUDIT_LOG_ENABLED=false

# SSO 单点登录
# DIFY_CUSTOM_SSO_ENABLED=false

# ------------------------------------------------------------------------------
# 环境相关配置
# ------------------------------------------------------------------------------
# 说明: 以下配置在不同环境中需要调整具体值

# 外部 API 地址 (示例)
# 开发环境: http://localhost:8000
# 测试环境: http://test-api:8000
# 生产环境: https://api.production.com
# DIFY_CUSTOM_EXTERNAL_API_URL=

# 对象存储配置 (示例)
# 开发环境: dify-dev-bucket
# 测试环境: dify-test-bucket
# 生产环境: dify-prod-bucket
# DIFY_CUSTOM_S3_BUCKET=

# 自定义域名 (示例)
# DIFY_CUSTOM_DOMAIN=

# ------------------------------------------------------------------------------
# 集成配置
# ------------------------------------------------------------------------------

# 第三方服务 API Key (根据需要添加)
# DIFY_CUSTOM_THIRD_PARTY_API_KEY=

# Webhook 回调地址
# DIFY_CUSTOM_WEBHOOK_URL=

# ------------------------------------------------------------------------------
# 开发调试
# ------------------------------------------------------------------------------

# 调试模式 (仅开发环境使用)
# DIFY_CUSTOM_DEBUG=false

# 日志级别 (DEBUG, INFO, WARNING, ERROR)
# DIFY_CUSTOM_LOG_LEVEL=INFO

# ==============================================================================
# 性能优化参数 (覆盖官方默认值)
# ==============================================================================
# 说明: 以下参数用于覆盖 docker/.env.example 中的官方默认值
#       适用于生产环境高并发场景
#       计算公式见文档: .custom/docs/migrate_docs/CUSTOM_CONFIG_PARAMS.md

# ------------------------------------------------------------------------------
# Gunicorn Worker 配置
# ------------------------------------------------------------------------------
# 总并发 = SERVER_WORKER_AMOUNT × SERVER_WORKER_CONNECTIONS

# Worker 进程数量 (官方默认: 1, 建议: CPU核心数-1)
SERVER_WORKER_AMOUNT=3

# 每个 Worker 的并发连接数 (官方默认: 10)
SERVER_WORKER_CONNECTIONS=100

# 请求处理超时 (官方默认: 360, 支持 SSE 长连接)
GUNICORN_TIMEOUT=360

# ------------------------------------------------------------------------------
# Celery 后台任务配置
# ------------------------------------------------------------------------------
# Celery 处理异步任务（文档索引、知识库处理等）
# 启用自动伸缩可在空闲时节省资源，繁忙时扩展处理能力

# 启用自动伸缩 (官方默认: false)
CELERY_AUTO_SCALE=true

# 最大 Worker 数量 (建议: 等于 CPU 核心数)
CELERY_MAX_WORKERS=4

# 最小 Worker 数量 (空闲时保持的最小进程数)
CELERY_MIN_WORKERS=1

# ------------------------------------------------------------------------------
# PostgreSQL 性能参数
# ------------------------------------------------------------------------------
# 总连接需求 = SERVER_WORKER_AMOUNT × (SQLALCHEMY_POOL_SIZE + SQLALCHEMY_MAX_OVERFLOW)
# POSTGRES_MAX_CONNECTIONS 必须大于总连接需求

# 数据库最大连接数 (官方默认: 100)
POSTGRES_MAX_CONNECTIONS=180

# 共享缓冲区 (官方默认: 128MB, 建议: 系统内存的 25%)
POSTGRES_SHARED_BUFFERS=4096MB

# 工作内存 (官方默认: 4MB, 用于排序/Join 操作)
POSTGRES_WORK_MEM=16MB

# 查询优化器缓存估算 (官方默认: 4096MB)
POSTGRES_EFFECTIVE_CACHE_SIZE=10240MB

# 维护操作内存 (官方默认: 64MB, 用于 VACUUM/索引构建等操作)
POSTGRES_MAINTENANCE_WORK_MEM=256MB

# ------------------------------------------------------------------------------
# SQLAlchemy 连接池配置
# ------------------------------------------------------------------------------

# 连接池溢出数 (官方默认: 10)
SQLALCHEMY_MAX_OVERFLOW=20

# 连接预检查 (官方默认: false, 启用可避免使用无效连接)
SQLALCHEMY_POOL_PRE_PING=true

# 后进先出策略 (官方默认: false, 启用可优先复用最新连接)
SQLALCHEMY_POOL_USE_LIFO=true

# ------------------------------------------------------------------------------
# 超时配置
# ------------------------------------------------------------------------------

# 前端工作流超时 (官方默认: 60000ms = 60秒)
TEXT_GENERATION_TIMEOUT_MS=120000

# 沙盒连接超时 (官方默认: 10秒)
CODE_EXECUTION_CONNECT_TIMEOUT=300

# 沙盒读取超时 (官方默认: 60秒)
CODE_EXECUTION_READ_TIMEOUT=300

# 沙盒写入超时 (官方默认: 10秒)
CODE_EXECUTION_WRITE_TIMEOUT=300

# 沙盒运行超时 (官方默认: 15秒)
SANDBOX_WORKER_TIMEOUT=300

# ------------------------------------------------------------------------------
# Sandbox 依赖管理配置
# ------------------------------------------------------------------------------
# 说明: 支持代码节点使用系统依赖库 (如 pyzbar, opencv 等)
# 文档: .custom/docs/migrate_docs/FORK_PRD_MIGRATION.md

# 自定义 Sandbox 镜像 (留空则使用官方镜像)
# 需要先构建: make -f Makefile.custom sandbox-build
SANDBOX_IMAGE=dify-sandbox-custom:latest

# 自定义 API 镜像 (留空则使用官方镜像)
# 用于 DOC/PPT 提取，包含 LibreOffice
# 需要先构建: make -f Makefile.custom api-build
# API_IMAGE=dify-api-custom:latest

# PIP 镜像 (国内加速, 官方默认为空)
PIP_MIRROR_URL=https://pypi.tuna.tsinghua.edu.cn/simple

# ------------------------------------------------------------------------------
# 文件上传限制
# ------------------------------------------------------------------------------

# 单文件上传大小限制 MB (官方默认: 15)
UPLOAD_FILE_SIZE_LIMIT=256

# 批量上传文件数量限制 (官方默认: 5)
UPLOAD_FILE_BATCH_LIMIT=30

# 图片文件大小限制 MB (官方默认: 10)
UPLOAD_IMAGE_FILE_SIZE_LIMIT=100

# 视频文件大小限制 MB (官方默认: 100)
UPLOAD_VIDEO_FILE_SIZE_LIMIT=1024

# 音频文件大小限制 MB (官方默认: 50)
UPLOAD_AUDIO_FILE_SIZE_LIMIT=200

# 文件访问超时秒数 (官方默认: 300 = 5分钟, 604800 = 7天)
FILES_ACCESS_TIMEOUT=604800

# ------------------------------------------------------------------------------
# 工作流配置
# ------------------------------------------------------------------------------

# 变量大小限制 字节 (官方默认: 204800 = 200KB)
MAX_VARIABLE_SIZE=409600

# 工作流文件上传数量限制 (官方默认: 10)
WORKFLOW_FILE_UPLOAD_LIMIT=100

# ------------------------------------------------------------------------------
# RAG 配置
# ------------------------------------------------------------------------------

# 索引分段最大 Token 长度 (官方默认: 4000)
INDEXING_MAX_SEGMENTATION_TOKENS_LENGTH=8000

# RAG 检索 Top-K 最大值 (官方默认: 10)
TOP_K_MAX_VALUE=100

# ------------------------------------------------------------------------------
# 日志配置
# ------------------------------------------------------------------------------

# 后端日志文件时区 (官方默认: UTC)
LOG_TZ=Asia/Shanghai

# [CUSTOM] 前端日志显示统一时区
# 所有用户查看的日志时间和时间范围查询都使用此时区
# 如果为空，则回退到用户个人时区设置
# 建议与 LOG_TZ 保持一致，确保前后端日志时区统一
DIFY_CUSTOM_LOG_TIMEZONE=Asia/Shanghai

# 日志文件最大大小 MB (官方默认: 20)
LOG_FILE_MAX_SIZE=128

# ------------------------------------------------------------------------------
# Nginx 配置
# ------------------------------------------------------------------------------

# 请求体大小限制 (官方默认: 100M, 需匹配文件上传限制)
NGINX_CLIENT_MAX_BODY_SIZE=300M

# 连接保持时间 (官方默认: 65秒)
NGINX_KEEPALIVE_TIMEOUT=120

# ------------------------------------------------------------------------------
# 端口配置 (非常规端口，便于多服务共存)
# ------------------------------------------------------------------------------

# Nginx HTTP 端口 (官方默认: 80)
EXPOSE_NGINX_PORT=20080

# Nginx HTTPS 端口 (官方默认: 443)
EXPOSE_NGINX_SSL_PORT=20443
