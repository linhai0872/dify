# ç¯å¢ƒé…ç½®ç®¡ç†æŒ‡å—

> **æœ¬æ–‡æ¡£è¯´æ˜**: Dify äºŒæ¬¡å¼€å‘é¡¹ç›®çš„ç¯å¢ƒé…ç½®ç®¡ç†æœºåˆ¶å’Œæœ€ä½³å®è·µ
> **æœ€åæ›´æ–°**: 2026-02-09
> **é€‚ç”¨èŒƒå›´**: å¼€å‘/æµ‹è¯•/ç”Ÿäº§ç¯å¢ƒ

---

## ğŸ“‹ ç›®å½•

1. [é…ç½®æ–‡ä»¶ç»“æ„](#é…ç½®æ–‡ä»¶ç»“æ„)
2. [é…ç½®ç®¡ç†æœºåˆ¶](#é…ç½®ç®¡ç†æœºåˆ¶)
3. [å¹‚ç­‰æ€§è®¾è®¡](#å¹‚ç­‰æ€§è®¾è®¡)
4. [æ­£ç¡®ä¿®æ”¹é…ç½®](#æ­£ç¡®ä¿®æ”¹é…ç½®)
5. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
6. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## é…ç½®æ–‡ä»¶ç»“æ„

### æ–‡ä»¶å¸ƒå±€

```
.custom/env/
â”œâ”€â”€ .env.custom.example       # æ¨¡æ¿ (check-in åˆ° Git)
â”œâ”€â”€ .env.custom.dev           # å¼€å‘ç¯å¢ƒ (gitignore)
â”œâ”€â”€ .env.custom.test          # æµ‹è¯•ç¯å¢ƒ (gitignore)
â””â”€â”€ .env.custom.prod          # ç”Ÿäº§ç¯å¢ƒ (gitignore)

api/
â”œâ”€â”€ .env.example              # å®˜æ–¹æ¨¡æ¿ (åªè¯»)
â”œâ”€â”€ .env                      # è¿è¡Œæ—¶ç”Ÿæˆ (gitignore)
â””â”€â”€ .env.custom               # [å·²åºŸå¼ƒ] ä¸å†ä½¿ç”¨

web/
â”œâ”€â”€ .env.example              # å®˜æ–¹æ¨¡æ¿ (åªè¯»)
â””â”€â”€ .env                      # è¿è¡Œæ—¶ç”Ÿæˆ (gitignore)

docker/
â”œâ”€â”€ .env.example              # å®˜æ–¹æ¨¡æ¿ (åªè¯»)
â”œâ”€â”€ .env                      # æµ‹è¯•/ç”Ÿäº§ç¯å¢ƒ (gitignore)
â””â”€â”€ middleware.env            # ä¸­é—´ä»¶é…ç½® (gitignore)
```

### é…ç½®ä¼˜å…ˆçº§

```
äºŒå¼€é…ç½® > å®˜æ–¹é»˜è®¤å€¼
.env.custom.* â†’ è¦†ç›– â†’ .env.example â†’ ç”Ÿæˆ â†’ .env
```

**ç¤ºä¾‹æµç¨‹**ï¼š

```bash
# 1. å®˜æ–¹æ¨¡æ¿ (api/.env.example)
SECRET_KEY=

# 2. äºŒå¼€é…ç½® (.custom/env/.env.custom.dev)
SECRET_KEY=sk-dev-random-key

# 3. æœ€ç»ˆç”Ÿæˆ (api/.env)
SECRET_KEY=              # ä»å®˜æ–¹æ¨¡æ¿
...
# ====== Custom Environment Variables (dev) ======
SECRET_KEY=sk-dev-random-key  # äºŒå¼€é…ç½®è¦†ç›–
```

---

## é…ç½®ç®¡ç†æœºåˆ¶

### å¼€å‘ç¯å¢ƒ (dev-*)

**è‡ªåŠ¨åˆå¹¶æœºåˆ¶**ï¼š

```bash
make -f Makefile.custom dev-start
```

æ‰§è¡Œæµç¨‹ï¼š

1. **æ£€æŸ¥ api/.env æ˜¯å¦å­˜åœ¨**
   - ä¸å­˜åœ¨ â†’ ä» `api/.env.example` å¤åˆ¶
   - å·²å­˜åœ¨ â†’ **è·³è¿‡é‡ç½®**ï¼ˆä¿æŠ¤æ‰‹åŠ¨ä¿®æ”¹ï¼‰

2. **æ£€æŸ¥æ˜¯å¦å·²è¿½åŠ äºŒå¼€é…ç½®**
   - æœªè¿½åŠ  â†’ è¿½åŠ  `.custom/env/.env.custom.dev`
   - å·²è¿½åŠ  â†’ **è·³è¿‡è¿½åŠ **ï¼ˆé¿å…é‡å¤ï¼‰

3. **å¯åŠ¨æœåŠ¡**

**æ¶‰åŠå‘½ä»¤**ï¼š
- `dev-api` - å¯åŠ¨åç«¯ (å‰å°)
- `dev-api-background` - å¯åŠ¨åç«¯ (åå°)
- `dev-web` - å¯åŠ¨å‰ç«¯
- `dev-start` - ä¸€é”®å¯åŠ¨
- `db-migrate-dev` - æ•°æ®åº“è¿ç§»

### æµ‹è¯•/ç”Ÿäº§ç¯å¢ƒ (test-*/prod-*)

**æ‰‹åŠ¨åˆå¹¶æœºåˆ¶**ï¼š

```bash
make -f Makefile.custom test-start
```

æ‰§è¡Œæµç¨‹ï¼š

1. **è°ƒç”¨ env-merge**
   - åˆå¹¶ `.env.example` + `.env.custom.*` â†’ `docker/.env`

2. **Docker Compose è¯»å–**
   - `docker compose --env-file docker/.env up -d`

**æ¶‰åŠå‘½ä»¤**ï¼š
- `test-start` / `prod-start` - ä¸€é”®å¯åŠ¨/éƒ¨ç½²
- `test-up` / `prod-up` - å¯åŠ¨å®¹å™¨
- `env-merge` - æ‰‹åŠ¨åˆå¹¶é…ç½®

---

## å¹‚ç­‰æ€§è®¾è®¡

### ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§ï¼Ÿ

**å¹‚ç­‰æ€§**: å¤šæ¬¡æ‰§è¡Œç›¸åŒæ“ä½œï¼Œç»“æœä¿æŒä¸€è‡´

**ç¤ºä¾‹**ï¼š

```bash
# ç¬¬ä¸€æ¬¡æ‰§è¡Œ
make -f Makefile.custom dev-api
# âœ… åˆå§‹åŒ– api/.env

# ç¬¬äºŒæ¬¡æ‰§è¡Œ
make -f Makefile.custom dev-api
# âœ… è·³è¿‡é‡ç½®ï¼Œä¿ç•™æ‰‹åŠ¨ä¿®æ”¹

# ç¬¬ä¸‰æ¬¡æ‰§è¡Œ
make -f Makefile.custom dev-api
# âœ… ä»ç„¶è·³è¿‡ï¼Œä¸ä¼šè¦†ç›–é…ç½®
```

### ä¸ºä»€ä¹ˆè¦å¹‚ç­‰æ€§ï¼Ÿ

**åœºæ™¯ 1: å¼€å‘è¿‡ç¨‹ä¸­é¢‘ç¹é‡å¯**
```bash
# ä¿®æ”¹äº† api/.env ä¸­çš„æŸä¸ªé…ç½®
vim api/.env

# é‡å¯åç«¯æœåŠ¡
make -f Makefile.custom dev-api
# âŒ æ—§é€»è¾‘: é…ç½®è¢«é‡ç½®ï¼Œä¿®æ”¹ä¸¢å¤±
# âœ… æ–°é€»è¾‘: é…ç½®ä¿ç•™ï¼Œä¿®æ”¹ç”Ÿæ•ˆ
```

**åœºæ™¯ 2: SECRET_KEY å¯¼è‡´çš„ç™»å½•é—®é¢˜**
```bash
# api/.env.example ä¸­ SECRET_KEY= ä¸ºç©º

# é¦–æ¬¡å¯åŠ¨
make -f Makefile.custom dev-start
# â†’ api/.env ä¸­ SECRET_KEY= ä¸ºç©º
# â†’ ç™»å½•æˆåŠŸï¼Œä½† token æ— æ³•éªŒè¯
# â†’ åˆ·æ–°é¡µé¢æ— é™é‡å®šå‘

# é‡å¯æœåŠ¡
make -f Makefile.custom dev-start
# âŒ æ—§é€»è¾‘: SECRET_KEY é‡æ–°å˜ç©ºï¼Œé—®é¢˜ä¾æ—§
# âœ… æ–°é€»è¾‘: åœ¨ .env.custom.dev ä¸­è®¾ç½®ï¼Œæ°¸ä¹…ç”Ÿæ•ˆ
```

### å®ç°æœºåˆ¶

**å…³é”®ä»£ç **ï¼ˆMakefile.customï¼‰ï¼š

```makefile
# âŒ æ—§é€»è¾‘ï¼ˆéå¹‚ç­‰ï¼‰
@cp api/.env.example api/.env

# âœ… æ–°é€»è¾‘ï¼ˆå¹‚ç­‰ï¼‰
@if [ ! -f "api/.env" ]; then \
    echo "$(GREEN)âœ“ åˆå§‹åŒ– api/.env (ä»æ¨¡æ¿)$(NC)"; \
    cp api/.env.example api/.env; \
else \
    echo "$(YELLOW)âš ï¸  api/.env å·²å­˜åœ¨ï¼Œè·³è¿‡é‡ç½®$(NC)"; \
fi
```

---

## æ­£ç¡®ä¿®æ”¹é…ç½®

### æ–¹æ³• 1: ä¿®æ”¹äºŒå¼€é…ç½®ï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯**: éœ€è¦æŒä¹…åŒ–çš„é…ç½®

```bash
# 1. ç¼–è¾‘äºŒå¼€é…ç½®
vim .custom/env/.env.custom.dev

# 2. æ·»åŠ é…ç½®
SECRET_KEY=sk-dev-your-random-key
INNER_API_KEY_FOR_PLUGIN=your-key

# 3. é‡å¯æœåŠ¡
make -f Makefile.custom dev-restart
```

**ä¼˜ç‚¹**ï¼š
- âœ… æŒä¹…åŒ–ï¼Œä¸ä¼šè¢«è¦†ç›–
- âœ… ç¬¦åˆäºŒå¼€è§„èŒƒ
- âœ… å¯ä»¥æäº¤åˆ° Gitï¼ˆå¦‚æœä¸å«æ•æ„Ÿä¿¡æ¯ï¼‰

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦é‡å¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆ

---

### æ–¹æ³• 2: ç›´æ¥ä¿®æ”¹è¿è¡Œæ—¶é…ç½®

**é€‚ç”¨åœºæ™¯**: ä¸´æ—¶è°ƒè¯•

```bash
# 1. ç¼–è¾‘è¿è¡Œæ—¶é…ç½®
vim api/.env

# 2. ä¿®æ”¹é…ç½®
SECRET_KEY=sk-temp-key

# 3. é‡å¯æœåŠ¡
make -f Makefile.custom dev-restart
```

**ä¼˜ç‚¹**ï¼š
- âœ… ç«‹å³ç”Ÿæ•ˆï¼ˆé‡å¯åï¼‰
- âœ… é€‚åˆä¸´æ—¶æµ‹è¯•

**ç¼ºç‚¹**ï¼š
- âŒ ä¸‹æ¬¡ `env-init` ä¼šè¢«è¦†ç›–ï¼ˆé™¤éå…ˆåˆ é™¤ api/.envï¼‰
- âŒ æ— æ³•æäº¤åˆ° Git

---

### æ–¹æ³• 3: ç¯å¢ƒå˜é‡è¦†ç›–

**é€‚ç”¨åœºæ™¯**: CI/CD æˆ– Docker

```bash
# æ–¹å¼ 1: å‘½ä»¤è¡Œ
SECRET_KEY=sk-production-key make -f Makefile.custom prod-start

# æ–¹å¼ 2: Docker Compose
# docker/.env
SECRET_KEY=sk-production-key
```

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæˆ‘çš„ SECRET_KEY æ¯æ¬¡éƒ½å˜ç©ºï¼Ÿ

**åŸå› **: æœªåœ¨äºŒå¼€é…ç½®ä¸­è®¾ç½®ï¼Œ`api/.env.example` ä¸­é»˜è®¤ä¸ºç©º

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# åœ¨ .custom/env/.env.custom.dev ä¸­æ·»åŠ 
SECRET_KEY=sk-dev-your-random-key
```

---

### Q2: ä¿®æ”¹äº† api/.envï¼Œé‡å¯åé…ç½®ä¸¢å¤±

**åŸå› **: æ—§ç‰ˆ Makefile æ¯æ¬¡å¯åŠ¨éƒ½ä¼šé‡ç½® `.env`

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **ç¡®è®¤ Makefile ç‰ˆæœ¬**ï¼šæ£€æŸ¥æ˜¯å¦å·²æ›´æ–°ä¸ºå¹‚ç­‰ç‰ˆæœ¬
2. **æ‰‹åŠ¨åˆ é™¤ `.env`**ï¼šç¡®ä¿ä½¿ç”¨æœ€æ–°é…ç½®
   ```bash
   rm api/.env web/.env docker/.env
   make -f Makefile.custom dev-start
   ```

---

### Q3: env-merge ä¼šè¦†ç›–æˆ‘çš„æ‰‹åŠ¨ä¿®æ”¹å—ï¼Ÿ

**æ˜¯çš„**ï¼Œenv-merge è®¾è®¡ä¸ºé‡æ–°ç”Ÿæˆ `docker/.env`

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **ä¿®æ”¹ `.env.example`**ï¼ˆæ¨èï¼‰
   - å°†é€šç”¨é…ç½®æäº¤åˆ°å®˜æ–¹æ¨¡æ¿
2. **ä¿®æ”¹ `.env.custom.*`**
   - å°†ç¯å¢ƒç‰¹å®šé…ç½®æ”¾åˆ°äºŒå¼€æ–‡ä»¶
3. **æ‰‹åŠ¨ç¼–è¾‘ `docker/.env` åï¼Œé¿å…å†æ¬¡è°ƒç”¨ env-merge**

---

### Q4: å¦‚ä½•ç”Ÿæˆ SECRET_KEYï¼Ÿ

**å¼€å‘ç¯å¢ƒ**ï¼ˆå¿«é€Ÿç”Ÿæˆï¼‰ï¼š
```bash
openssl rand -base64 42
```

**ç”Ÿäº§ç¯å¢ƒ**ï¼ˆå»ºè®®ä½¿ç”¨å¯†é’¥ç®¡ç†æœåŠ¡ï¼‰ï¼š
- AWS Secrets Manager
- HashiCorp Vault
- Azure Key Vault

---

### Q5: ä¸åŒç¯å¢ƒå¯ä»¥ä½¿ç”¨ç›¸åŒçš„ SECRET_KEY å—ï¼Ÿ

**âŒ ä¸å»ºè®®**ï¼Œå­˜åœ¨ä»¥ä¸‹é£é™©ï¼š

1. **å®‰å…¨é£é™©**: å¼€å‘ç¯å¢ƒå¯†é’¥æ³„éœ²å½±å“ç”Ÿäº§
2. **Session æ··ä¹±**: ç›¸åŒå¯†é’¥å¯¼è‡´è·¨ç¯å¢ƒ session è®¤è¯é—®é¢˜

**æœ€ä½³å®è·µ**ï¼š

| ç¯å¢ƒ | SECRET_KEY ç­–ç•¥ |
|------|----------------|
| å¼€å‘ | æœ¬åœ°ç”Ÿæˆï¼Œä¸æäº¤ Git |
| æµ‹è¯• | CI/CD è‡ªåŠ¨ç”Ÿæˆæˆ–å¯†é’¥ç®¡ç†æœåŠ¡ |
| ç”Ÿäº§ | å¼ºå¯†é’¥ï¼Œå®šæœŸè½®æ¢ |

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: ç™»å½•åç«‹å³ 401ï¼Œæ— é™é‡å®šå‘

**ç—‡çŠ¶**ï¼š
- ç™»å½•æ¥å£è¿”å› 200
- éšåæ‰€æœ‰è¯·æ±‚è¿”å› 401
- åˆ·æ–°é¡µé¢é‡å®šå‘åˆ°ç™»å½•é¡µ

**åŸå› **ï¼š`SECRET_KEY` ä¸ºç©ºæˆ–ä¸ä¸€è‡´

**æ’æŸ¥æ­¥éª¤**ï¼š

```bash
# 1. æ£€æŸ¥ api/.env ä¸­çš„ SECRET_KEY
grep SECRET_KEY api/.env

# 2. æ£€æŸ¥åç«¯æ—¥å¿—
tail -50 .custom/logs/api.log | grep -E "401|refresh-token"

# 3. æ£€æŸ¥æ˜¯å¦ä¸ºç©º
grep "^SECRET_KEY=$" api/.env
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# åœ¨ .custom/env/.env.custom.dev ä¸­è®¾ç½®
SECRET_KEY=sk-dev-your-random-key

# åˆ é™¤æ—§çš„ api/.env å¹¶é‡å¯
rm api/.env
make -f Makefile.custom dev-restart
```

---

### é—®é¢˜ 2: æ’ä»¶åŠŸèƒ½æ— æ³•ä½¿ç”¨

**ç—‡çŠ¶**ï¼š
- æ’ä»¶åˆ—è¡¨ä¸ºç©º
- å®‰è£…æ’ä»¶å¤±è´¥

**åŸå› **ï¼š`INNER_API_KEY_FOR_PLUGIN` æˆ– `PLUGIN_DAEMON_KEY` ä¸åŒ¹é…

**æ’æŸ¥æ­¥éª¤**ï¼š

```bash
# 1. æ£€æŸ¥é…ç½®æ˜¯å¦ä¸€è‡´
grep INNER_API_KEY api/.env .custom/env/.env.custom.dev
grep PLUGIN_DAEMON_KEY api/.env .custom/env/.env.custom.dev

# 2. æ£€æŸ¥æ’ä»¶æœåŠ¡æ—¥å¿—
docker logs dify-custom-dev-plugin_daemon-1
```

---

### é—®é¢˜ 3: é…ç½®ä¿®æ”¹ä¸ç”Ÿæ•ˆ

**å¯èƒ½åŸå› **ï¼š

1. **æœªè¿½åŠ äºŒå¼€é…ç½®**
   ```bash
   # æ£€æŸ¥ api/.env ä¸­æ˜¯å¦åŒ…å«ä»¥ä¸‹æ ‡è®°
   grep "# ====== Custom Environment Variables (dev) ======" api/.env
   ```

2. **é…ç½®è¢«é‡å¤è¿½åŠ **
   ```bash
   # æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„æ ‡è®°
   grep -c "# ====== Custom Environment Variables" api/.env
   ```

3. **Pydantic ç¼“å­˜**
   ```bash
   # é‡å¯ Python è¿›ç¨‹
   make -f Makefile.custom dev-restart
   ```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# 1. æ¸…ç†æ—§é…ç½®
rm api/.env web/.env docker/.env

# 2. é‡æ–°åˆå§‹åŒ–
make -f Makefile.custom dev-setup

# 3. é‡å¯æœåŠ¡
make -f Makefile.custom dev-start
```

---

## æœ€ä½³å®è·µ

### å¼€å‘ç¯å¢ƒ

1. **âœ… åœ¨ `.env.custom.dev` ä¸­é…ç½®æ‰€æœ‰éœ€è¦è¦†ç›–çš„å˜é‡**
2. **âœ… é¦–æ¬¡è®¾ç½®åä¸è¦è½»æ˜“ä¿®æ”¹ `SECRET_KEY`**
3. **âœ… ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç®¡ç† `.env.custom.example`**
4. **âŒ ä¸è¦æ‰‹åŠ¨ä¿®æ”¹ `api/.env` æˆ– `web/.env`**ï¼ˆé™¤éä¸´æ—¶è°ƒè¯•ï¼‰

### æµ‹è¯•/ç”Ÿäº§ç¯å¢ƒ

1. **âœ… ä½¿ç”¨å¯†é’¥ç®¡ç†æœåŠ¡å­˜å‚¨æ•æ„Ÿé…ç½®**
2. **âœ… é€šè¿‡ CI/CD æ³¨å…¥ç¯å¢ƒå˜é‡**
3. **âœ… å®šæœŸè½®æ¢å¯†é’¥**
4. **âŒ ä¸è¦å°†ç”Ÿäº§é…ç½®æäº¤åˆ° Git**

### é…ç½®æ£€æŸ¥æ¸…å•

- [ ] SECRET_KEY å·²è®¾ç½®ï¼ˆéç©ºï¼‰
- [ ] INNER_API_KEY_FOR_PLUGIN ä¸æ’ä»¶æœåŠ¡ä¸€è‡´
- [ ] PLUGIN_DAEMON_KEY ä¸æ’ä»¶æœåŠ¡ä¸€è‡´
- [ ] æ•°æ®åº“è¿æ¥é…ç½®æ­£ç¡®
- [ ] Redis è¿æ¥é…ç½®æ­£ç¡®
- [ ] å‘é‡æ•°æ®åº“é…ç½®æ­£ç¡®
- [ ] æ–‡ä»¶å­˜å‚¨é…ç½®æ­£ç¡®

---

## ç›¸å…³æ–‡æ¡£

- [å¼€å‘è§„èŒƒ README](README.md)
- [é…ç½®å‚æ•°è¯´æ˜](../migrate_docs/CUSTOM_CONFIG_PARAMS.md)
- [Sandbox ä¾èµ–ç®¡ç†](README.md#sandbox-ä¾èµ–ç®¡ç†)
