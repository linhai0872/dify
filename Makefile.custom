# Dify äºŒæ¬¡å¼€å‘ Makefile
# ç”¨æ³•: make -f Makefile.custom <target>

# é…ç½®
DOCKER_REGISTRY ?= ghcr.io/linhai0872
PROJECT_NAME ?= dify-custom
VERSION ?= $(shell git rev-parse --short HEAD)

# é¢œè‰²
GREEN := \033[0;32m
YELLOW := \033[0;33m
RED := \033[0;31m
NC := \033[0m

.DEFAULT_GOAL := help

# ============================================================
# ä¸€é”®å‘½ä»¤ (é›†æˆåº¦æœ€é«˜)
# ============================================================

setup-dev: ## ğŸš€ ä¸€é”®åˆå§‹åŒ–å¼€å‘ç¯å¢ƒ
	@echo "$(GREEN)ğŸ”§ åˆå§‹åŒ–å¼€å‘ç¯å¢ƒ...$(NC)"
	@$(MAKE) -f Makefile.custom env-init ENV=dev
	@echo ""
	@echo "$(GREEN)âœ… å¼€å‘ç¯å¢ƒåˆå§‹åŒ–å®Œæˆï¼$(NC)"
	@echo "$(YELLOW)ğŸ“ ä¸‹ä¸€æ­¥:$(NC)"
	@echo "  1. ç¼–è¾‘é…ç½®: .custom/env/.env.custom.dev"
	@echo "  2. å¯åŠ¨ç¯å¢ƒ: make -f Makefile.custom start-dev"

setup-test: ## ğŸ§ª ä¸€é”®åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ
	@echo "$(GREEN)ğŸ”§ åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ...$(NC)"
	@$(MAKE) -f Makefile.custom env-init ENV=test
	@echo ""
	@echo "$(GREEN)âœ… æµ‹è¯•ç¯å¢ƒåˆå§‹åŒ–å®Œæˆï¼$(NC)"
	@echo "$(YELLOW)ğŸ“ ä¸‹ä¸€æ­¥:$(NC)"
	@echo "  1. ç¼–è¾‘é…ç½®: .custom/env/.env.custom.test"
	@echo "  2. å¯åŠ¨ç¯å¢ƒ: make -f Makefile.custom start-test"

setup-prod: ## ğŸ­ ä¸€é”®åˆå§‹åŒ–ç”Ÿäº§ç¯å¢ƒ (æœåŠ¡å™¨æ‰§è¡Œ)
	@echo "$(GREEN)ğŸ”§ åˆå§‹åŒ–ç”Ÿäº§ç¯å¢ƒ...$(NC)"
	@$(MAKE) -f Makefile.custom env-init ENV=prod
	@echo ""
	@echo "$(GREEN)âœ… ç”Ÿäº§ç¯å¢ƒåˆå§‹åŒ–å®Œæˆï¼$(NC)"
	@echo "$(YELLOW)ğŸ“ ä¸‹ä¸€æ­¥:$(NC)"
	@echo "  1. ç¼–è¾‘é…ç½®: .custom/env/.env.custom.prod"
	@echo "  2. æ„å»ºéƒ¨ç½²: make -f Makefile.custom deploy-prod"

stop-dev: ## â¹ï¸  ä¸€é”®åœæ­¢å¼€å‘ç¯å¢ƒ
	@echo "$(YELLOW)â¹ï¸  åœæ­¢å¼€å‘ç¯å¢ƒ...$(NC)"
	@# åœæ­¢åç«¯ (å¯èƒ½åœ¨ç«¯å£ 5001)
	@if lsof -i:5001 > /dev/null 2>&1; then \
		echo "$(YELLOW)åœæ­¢åç«¯è¿›ç¨‹ (ç«¯å£ 5001)...$(NC)"; \
		lsof -t -i:5001 | xargs kill -9 2>/dev/null || true; \
		echo "$(GREEN)âœ“ åç«¯å·²åœæ­¢$(NC)"; \
	else \
		echo "$(YELLOW)åç«¯æœªè¿è¡Œ$(NC)"; \
	fi
	@# åœæ­¢å‰ç«¯ (å¯èƒ½åœ¨ç«¯å£ 3000)
	@if lsof -i:3000 > /dev/null 2>&1; then \
		echo "$(YELLOW)åœæ­¢å‰ç«¯è¿›ç¨‹ (ç«¯å£ 3000)...$(NC)"; \
		lsof -t -i:3000 | xargs kill -9 2>/dev/null || true; \
		echo "$(GREEN)âœ“ å‰ç«¯å·²åœæ­¢$(NC)"; \
	else \
		echo "$(YELLOW)å‰ç«¯æœªè¿è¡Œ$(NC)"; \
	fi
	@# åœæ­¢ä¸­é—´ä»¶
	@$(MAKE) -f Makefile.custom middleware-down
	@echo "$(GREEN)âœ… å¼€å‘ç¯å¢ƒå·²åœæ­¢$(NC)"

restart-dev: ## ğŸ”„ ä¸€é”®é‡å¯å¼€å‘ç¯å¢ƒ
	@echo "$(YELLOW)ğŸ”„ é‡å¯å¼€å‘ç¯å¢ƒ...$(NC)"
	@$(MAKE) -f Makefile.custom stop-dev
	@echo ""
	@$(MAKE) -f Makefile.custom start-dev

start-dev: ## ğŸš€ ä¸€é”®å¯åŠ¨å¼€å‘ç¯å¢ƒ (åç«¯+å‰ç«¯)
	@if [ ! -f ".custom/env/.env.custom.dev" ]; then \
		echo "$(RED)âŒ è¯·å…ˆåˆå§‹åŒ–å¼€å‘ç¯å¢ƒ: make -f Makefile.custom setup-dev$(NC)"; \
		exit 1; \
	fi
	@echo "$(GREEN)ğŸš€ å¯åŠ¨å¼€å‘ç¯å¢ƒ...$(NC)"
	@echo ""
	@echo "$(YELLOW)æ­¥éª¤ 1/5: å¯åŠ¨ä¸­é—´ä»¶$(NC)"
	@$(MAKE) -f Makefile.custom middleware-up
	@echo ""
	@echo "$(GREEN)âœ… ä¸­é—´ä»¶å·²å¯åŠ¨$(NC)"
	@echo ""
	@echo "$(YELLOW)æ­¥éª¤ 2/5: ç­‰å¾…æ•°æ®åº“å°±ç»ª...$(NC)"
	@sleep 3
	@echo "$(YELLOW)æ­¥éª¤ 3/5: æ‰§è¡Œæ•°æ®åº“è¿ç§»$(NC)"
	@$(MAKE) -f Makefile.custom db-migrate-dev
	@echo ""
	@echo "$(GREEN)âœ… æ•°æ®åº“è¿ç§»å®Œæˆ$(NC)"
	@echo ""
	@echo "$(YELLOW)æ­¥éª¤ 4/5: å¯åŠ¨åç«¯ (åå°è¿è¡Œ)$(NC)"
	@$(MAKE) -f Makefile.custom dev-api-background
	@echo ""
	@echo "$(YELLOW)æ­¥éª¤ 5/5: å¯åŠ¨å‰ç«¯$(NC)"
	@echo ""
	@echo "$(GREEN)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo "$(GREEN)  åç«¯: http://localhost:5001 (åå°è¿è¡Œ)$(NC)"
	@echo "$(GREEN)  å‰ç«¯: http://localhost:3000 (å½“å‰ç»ˆç«¯)$(NC)"
	@echo "$(GREEN)  åç«¯æ—¥å¿—: tail -f .custom/logs/api.log$(NC)"
	@echo "$(GREEN)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@$(MAKE) -f Makefile.custom dev-web

start-test: ## ğŸ§ª ä¸€é”®å¯åŠ¨æµ‹è¯•ç¯å¢ƒ
	@if [ ! -f ".custom/env/.env.custom.test" ]; then \
		echo "$(RED)âŒ è¯·å…ˆåˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ: make -f Makefile.custom setup-test$(NC)"; \
		exit 1; \
	fi
	@echo "$(GREEN)ğŸ§ª ä¸€é”®å¯åŠ¨æµ‹è¯•ç¯å¢ƒ...$(NC)"
	@echo ""
	@echo "$(YELLOW)æ­¥éª¤ 1/3: æ„å»ºæµ‹è¯•é•œåƒ$(NC)"
	@$(MAKE) -f Makefile.custom test-build
	@echo ""
	@echo "$(YELLOW)æ­¥éª¤ 2/3: å¯åŠ¨æµ‹è¯•å®¹å™¨$(NC)"
	@$(MAKE) -f Makefile.custom test-up
	@echo ""
	@echo "$(YELLOW)æ­¥éª¤ 3/3: ç­‰å¾…æ•°æ®åº“è¿ç§»å®Œæˆ...$(NC)"
	@echo "$(YELLOW)ğŸ’¡ æç¤º: Docker å®¹å™¨å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ‰§è¡Œæ•°æ®åº“è¿ç§»$(NC)"
	@sleep 10
	@echo ""
	@echo "$(GREEN)âœ… æµ‹è¯•ç¯å¢ƒå·²å¯åŠ¨ï¼$(NC)"
	@echo "$(GREEN)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo "$(GREEN)  è®¿é—®åœ°å€: http://localhost (ç«¯å£ 80)$(NC)"
	@echo "$(GREEN)  æŸ¥çœ‹æ—¥å¿—: make -f Makefile.custom test-logs$(NC)"
	@echo "$(GREEN)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"

deploy-prod: ## ğŸ­ ä¸€é”®æ„å»ºå¹¶éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒ
	@if [ ! -f ".custom/env/.env.custom.prod" ]; then \
		echo "$(RED)âŒ è¯·å…ˆåˆå§‹åŒ–ç”Ÿäº§ç¯å¢ƒ: make -f Makefile.custom setup-prod$(NC)"; \
		exit 1; \
	fi
	@echo "$(GREEN)ğŸ­ ä¸€é”®éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒ...$(NC)"
	@echo ""
	@echo "$(YELLOW)æ­¥éª¤ 1/3: æ„å»ºç”Ÿäº§é•œåƒ$(NC)"
	@$(MAKE) -f Makefile.custom prod-build
	@echo ""
	@echo "$(YELLOW)æ­¥éª¤ 2/3: æ¨é€é•œåƒåˆ°ä»“åº“$(NC)"
	@$(MAKE) -f Makefile.custom prod-push
	@echo ""
	@echo "$(YELLOW)æ­¥éª¤ 3/3: æ»šåŠ¨æ›´æ–°ç”Ÿäº§ç¯å¢ƒ$(NC)"
	@$(MAKE) -f Makefile.custom prod-deploy
	@echo ""
	@echo "$(GREEN)âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆï¼$(NC)"

# ============================================================
# ç¯å¢ƒå˜é‡ç®¡ç†
# ============================================================

env-init: ## åˆå§‹åŒ–ç¯å¢ƒå˜é‡ (ç”¨æ³•: make env-init ENV=dev|test|prod)
	@if [ -z "$(ENV)" ]; then \
		echo "$(RED)âŒ è¯·æŒ‡å®šç¯å¢ƒ: make -f Makefile.custom env-init ENV=dev|test|prod$(NC)"; \
		exit 1; \
	fi
	@echo "$(GREEN)ğŸ”§ åˆå§‹åŒ– $(ENV) ç¯å¢ƒå˜é‡...$(NC)"
	@[ -f api/.env ] || cp api/.env.example api/.env
	@[ -f web/.env ] || cp web/.env.example web/.env
	@[ -f docker/.env ] || cp docker/.env.example docker/.env
	@[ -f docker/middleware.env ] || ([ -f docker/middleware.env.example ] && cp docker/middleware.env.example docker/middleware.env || true)
	@mkdir -p .custom/env
	@[ -f .custom/env/.env.custom.$(ENV) ] || cp .custom/env/.env.custom.example .custom/env/.env.custom.$(ENV)
	@echo "$(GREEN)âœ… å®Œæˆï¼è¯·ç¼–è¾‘ .custom/env/.env.custom.$(ENV) é…ç½®äºŒå¼€å˜é‡$(NC)"
	@echo "$(YELLOW)ğŸ’¡ æç¤º: ä¸‰å¥—ç¯å¢ƒå˜é‡åˆ†åˆ«æ˜¯:$(NC)"
	@echo "   - .custom/env/.env.custom.dev  (å¼€å‘ç¯å¢ƒ)"
	@echo "   - .custom/env/.env.custom.test (æµ‹è¯•ç¯å¢ƒ)"
	@echo "   - .custom/env/.env.custom.prod (ç”Ÿäº§ç¯å¢ƒ)"

env-merge: ## åˆå¹¶äºŒå¼€ç¯å¢ƒå˜é‡åˆ° docker/.env (ç”¨æ³•: make env-merge ENV=test|prod)
	@if [ -z "$(ENV)" ]; then \
		echo "$(RED)âŒ è¯·æŒ‡å®šç¯å¢ƒ: make -f Makefile.custom env-merge ENV=test|prod$(NC)"; \
		exit 1; \
	fi
	@echo "$(GREEN)ğŸ”„ åˆå¹¶ $(ENV) ç¯å¢ƒå˜é‡åˆ° docker/.env...$(NC)"
	@if [ ! -f "docker/.env" ]; then \
		echo "$(RED)âŒ docker/.env ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œ: make -f Makefile.custom env-init ENV=$(ENV)$(NC)"; \
		exit 1; \
	fi
	@if [ ! -f ".custom/env/.env.custom.$(ENV)" ]; then \
		echo "$(RED)âŒ .custom/env/.env.custom.$(ENV) ä¸å­˜åœ¨$(NC)"; \
		exit 1; \
	fi
	@cp docker/.env.example docker/.env
	@echo "" >> docker/.env
	@echo "# ====== Custom Environment Variables ($(ENV)) ======" >> docker/.env
	@cat .custom/env/.env.custom.$(ENV) >> docker/.env
	@echo "$(GREEN)âœ… å·²åˆå¹¶ .custom/env/.env.custom.$(ENV) â†’ docker/.env$(NC)"

# ============================================================
# å¼€å‘ç¯å¢ƒ (æœ¬åœ°æºç å¯åŠ¨ï¼Œæ”¯æŒçƒ­é‡è½½)
# ============================================================

dev-start: ## å¯åŠ¨å¼€å‘ç¯å¢ƒ (çƒ­é‡è½½)
	@echo "$(GREEN)ğŸš€ å¯åŠ¨å¼€å‘ç¯å¢ƒ...$(NC)"
	@echo "$(YELLOW)è¯·åœ¨ä¸¤ä¸ªç»ˆç«¯åˆ†åˆ«è¿è¡Œ:$(NC)"
	@echo "  ç»ˆç«¯1 (åç«¯): make -f Makefile.custom dev-api"
	@echo "  ç»ˆç«¯2 (å‰ç«¯): make -f Makefile.custom dev-web"
	@echo ""
	@echo "$(YELLOW)ç¡®ä¿ä¸­é—´ä»¶å·²å¯åŠ¨:$(NC) make -f Makefile.custom middleware-up"
	@echo "$(YELLOW)ç¡®ä¿ç¯å¢ƒå˜é‡å·²é…ç½®:$(NC) make -f Makefile.custom env-init ENV=dev"

dev-api: ## å¯åŠ¨åç«¯å¼€å‘ç¯å¢ƒ (è‡ªåŠ¨åˆå¹¶ api/.env + .custom/env/.env.custom.dev)
	@echo "$(GREEN)ğŸš€ å¯åŠ¨åç«¯ (å¼€å‘ç¯å¢ƒ)...$(NC)"
	@# [CUSTOM] æ£€æµ‹ LibreOffice (DOC/PPT æå–ä¾èµ–)
	@if ! which soffice > /dev/null 2>&1; then \
		echo "$(YELLOW)âš ï¸  LibreOffice æœªå®‰è£…ï¼ŒDOC/PPT æå–åŠŸèƒ½ä¸å¯ç”¨$(NC)"; \
		echo "$(YELLOW)   å®‰è£…æ–¹æ³•: brew install --cask libreoffice (macOS)$(NC)"; \
		echo "$(YELLOW)            apt-get install libreoffice-writer-nogui libreoffice-impress-nogui (Linux)$(NC)"; \
		echo ""; \
	fi
	@if [ ! -f "api/.env.example" ]; then \
		echo "$(RED)âŒ api/.env.example ä¸å­˜åœ¨$(NC)"; \
		exit 1; \
	fi
	@echo "$(GREEN)âœ“ é‡ç½® api/.env (ä»æ¨¡æ¿)$(NC)"
	@cp api/.env.example api/.env
	@if [ -f ".custom/env/.env.custom.dev" ]; then \
		echo "$(GREEN)âœ“ è¿½åŠ äºŒå¼€ç¯å¢ƒå˜é‡: .custom/env/.env.custom.dev$(NC)"; \
		echo "" >> api/.env; \
		echo "# ====== Custom Environment Variables (dev) ======" >> api/.env; \
		cat .custom/env/.env.custom.dev >> api/.env; \
	else \
		echo "$(YELLOW)âš ï¸  .custom/env/.env.custom.dev ä¸å­˜åœ¨ï¼Œä»…ä½¿ç”¨å®˜æ–¹ç¯å¢ƒå˜é‡$(NC)"; \
	fi
	@echo "$(GREEN)âœ“ ç¯å¢ƒå˜é‡å°†ç”± Pydantic è‡ªåŠ¨åŠ è½½$(NC)"
	@cd api && uv run flask run --host 0.0.0.0 --port 5001 --debug

dev-web: ## å¯åŠ¨å‰ç«¯å¼€å‘ç¯å¢ƒ (è‡ªåŠ¨åˆå¹¶ web/.env + .custom/env/.env.custom.dev)
	@echo "$(GREEN)ğŸš€ å¯åŠ¨å‰ç«¯ (å¼€å‘ç¯å¢ƒ)...$(NC)"
	@if [ ! -f "web/.env.example" ]; then \
		echo "$(RED)âŒ web/.env.example ä¸å­˜åœ¨$(NC)"; \
		exit 1; \
	fi
	@echo "$(GREEN)âœ“ é‡ç½® web/.env (ä»æ¨¡æ¿)$(NC)"
	@cp web/.env.example web/.env
	@if [ -f ".custom/env/.env.custom.dev" ]; then \
		echo "$(GREEN)âœ“ è¿½åŠ äºŒå¼€ç¯å¢ƒå˜é‡: .custom/env/.env.custom.dev$(NC)"; \
		echo "" >> web/.env; \
		echo "# ====== Custom Environment Variables (dev) ======" >> web/.env; \
		cat .custom/env/.env.custom.dev >> web/.env; \
	else \
		echo "$(YELLOW)âš ï¸  .custom/env/.env.custom.dev ä¸å­˜åœ¨ï¼Œä»…ä½¿ç”¨å®˜æ–¹ç¯å¢ƒå˜é‡$(NC)"; \
	fi
	@echo "$(GREEN)âœ“ ç¯å¢ƒå˜é‡å°†ç”± Next.js è‡ªåŠ¨åŠ è½½$(NC)"
	@cd web && pnpm dev --turbo

dev-api-background: ## å¯åŠ¨åç«¯å¼€å‘ç¯å¢ƒ (åå°è¿è¡Œï¼Œæ—¥å¿—è¾“å‡ºåˆ°æ–‡ä»¶)
	@echo "$(GREEN)ğŸš€ å¯åŠ¨åç«¯ (åå°è¿è¡Œ)...$(NC)"
	@# [CUSTOM] æ£€æµ‹ LibreOffice (DOC/PPT æå–ä¾èµ–)
	@if ! which soffice > /dev/null 2>&1; then \
		echo "$(YELLOW)âš ï¸  LibreOffice æœªå®‰è£…ï¼ŒDOC/PPT æå–åŠŸèƒ½ä¸å¯ç”¨$(NC)"; \
		echo "$(YELLOW)   å®‰è£…æ–¹æ³•: brew install --cask libreoffice (macOS)$(NC)"; \
		echo ""; \
	fi
	@if [ ! -f "api/.env.example" ]; then \
		echo "$(RED)âŒ api/.env.example ä¸å­˜åœ¨$(NC)"; \
		exit 1; \
	fi
	@echo "$(GREEN)âœ“ é‡ç½® api/.env (ä»æ¨¡æ¿)$(NC)"
	@cp api/.env.example api/.env
	@if [ -f ".custom/env/.env.custom.dev" ]; then \
		echo "$(GREEN)âœ“ è¿½åŠ äºŒå¼€ç¯å¢ƒå˜é‡: .custom/env/.env.custom.dev$(NC)"; \
		echo "" >> api/.env; \
		echo "# ====== Custom Environment Variables (dev) ======" >> api/.env; \
		cat .custom/env/.env.custom.dev >> api/.env; \
	else \
		echo "$(YELLOW)âš ï¸  .custom/env/.env.custom.dev ä¸å­˜åœ¨ï¼Œä»…ä½¿ç”¨å®˜æ–¹ç¯å¢ƒå˜é‡$(NC)"; \
	fi
	@mkdir -p .custom/logs
	@echo "$(GREEN)âœ“ ç¯å¢ƒå˜é‡å°†ç”± Pydantic è‡ªåŠ¨åŠ è½½$(NC)"
	@echo "$(GREEN)âœ“ åç«¯æ—¥å¿—å°†è¾“å‡ºåˆ°: .custom/logs/api.log$(NC)"
	@nohup sh -c 'cd api && uv run flask run --host 0.0.0.0 --port 5001 --debug' > .custom/logs/api.log 2>&1 &
	@echo "$(YELLOW)â³ ç­‰å¾…åç«¯å¯åŠ¨ (æœ€å¤š 15 ç§’)...$(NC)"
	@for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15; do \
		if lsof -i:5001 > /dev/null 2>&1; then \
			echo "$(GREEN)âœ… åç«¯å·²åœ¨åå°å¯åŠ¨ (PID: $$(lsof -t -i:5001 | head -1))$(NC)"; \
			break; \
		fi; \
		if [ $$i -eq 15 ]; then \
			echo "$(RED)âŒ åç«¯å¯åŠ¨è¶…æ—¶ï¼Œè¯·æ£€æŸ¥æ—¥å¿—: .custom/logs/api.log$(NC)"; \
			tail -20 .custom/logs/api.log 2>/dev/null || true; \
			exit 1; \
		fi; \
		sleep 1; \
	done

middleware-up: ## å¯åŠ¨ä¸­é—´ä»¶ (DB, Redis, Weaviateç­‰)
	@echo "$(GREEN)ğŸ³ å¯åŠ¨ä¸­é—´ä»¶...$(NC)"
	@# [CUSTOM] æ”¯æŒ override æ–‡ä»¶ï¼ˆSandbox å¢å¼ºé…ç½®ï¼‰
	@if [ -f ".custom/docker/docker-compose.override.yaml" ]; then \
		echo "$(YELLOW)ğŸ“¦ ä½¿ç”¨ Sandbox å¢å¼ºé…ç½®: .custom/docker/docker-compose.override.yaml$(NC)"; \
		cd docker && docker compose -f docker-compose.middleware.yaml \
			-f ../.custom/docker/docker-compose.override.yaml \
			--env-file middleware.env -p $(PROJECT_NAME)-dev up -d; \
	else \
		cd docker && docker compose -f docker-compose.middleware.yaml \
			--env-file middleware.env -p $(PROJECT_NAME)-dev up -d; \
	fi
	@echo "$(GREEN)âœ… ä¸­é—´ä»¶å·²å¯åŠ¨$(NC)"

middleware-down: ## åœæ­¢ä¸­é—´ä»¶
	@echo "$(YELLOW)â¹ï¸  åœæ­¢ä¸­é—´ä»¶...$(NC)"
	@cd docker && docker compose -f docker-compose.middleware.yaml --env-file middleware.env -p $(PROJECT_NAME)-dev down

# ============================================================
# æµ‹è¯•ç¯å¢ƒ (æœ¬åœ° Docker æ¨¡æ‹Ÿç”Ÿäº§)
# ============================================================

test-build: ## æ„å»ºæµ‹è¯•é•œåƒ (è‡ªåŠ¨åŒ…å« LibreOffice)
	@echo "$(GREEN)ğŸ”¨ æ„å»ºæµ‹è¯•é•œåƒ...$(NC)"
	@echo "$(YELLOW)æ­¥éª¤ 1/3: æ„å»ºåŸºç¡€ API é•œåƒ$(NC)"
	docker build -t $(PROJECT_NAME)-api:test-base ./api
	@echo "$(YELLOW)æ­¥éª¤ 2/3: æ‰©å±• API é•œåƒ (æ·»åŠ  LibreOffice)$(NC)"
	docker build -t $(PROJECT_NAME)-api:test \
		--build-arg BASE_IMAGE=$(PROJECT_NAME)-api:test-base \
		-f .custom/docker/api/Dockerfile.api-custom .
	@echo "$(YELLOW)æ­¥éª¤ 3/3: æ„å»º Web é•œåƒ$(NC)"
	docker build -t $(PROJECT_NAME)-web:test ./web
	@echo "$(GREEN)âœ… æµ‹è¯•é•œåƒæ„å»ºå®Œæˆ (å« LibreOffice)$(NC)"

test-up: ## å¯åŠ¨æµ‹è¯•ç¯å¢ƒ
	@echo "$(GREEN)ğŸ§ª å¯åŠ¨æµ‹è¯•ç¯å¢ƒ...$(NC)"
	@$(MAKE) -f Makefile.custom env-merge ENV=test
	@cd docker && docker compose -f docker-compose.yaml --env-file .env -p $(PROJECT_NAME)-test up -d
	@echo "$(GREEN)âœ… æµ‹è¯•ç¯å¢ƒå·²å¯åŠ¨$(NC)"
	@echo "è®¿é—®: http://localhost (ç«¯å£ 80)"

test-down: ## åœæ­¢æµ‹è¯•ç¯å¢ƒ
	@echo "$(YELLOW)â¹ï¸  åœæ­¢æµ‹è¯•ç¯å¢ƒ...$(NC)"
	@cd docker && docker compose -f docker-compose.yaml -p $(PROJECT_NAME)-test down

test-restart: ## ğŸ”„ é‡å¯æµ‹è¯•ç¯å¢ƒ
	@echo "$(YELLOW)ğŸ”„ é‡å¯æµ‹è¯•ç¯å¢ƒ...$(NC)"
	@$(MAKE) -f Makefile.custom test-down
	@echo ""
	@$(MAKE) -f Makefile.custom start-test

test-logs: ## æŸ¥çœ‹æµ‹è¯•ç¯å¢ƒæ—¥å¿—
	@cd docker && docker compose -f docker-compose.yaml -p $(PROJECT_NAME)-test logs -f

# ============================================================
# ç”Ÿäº§ç¯å¢ƒ
# ============================================================

prod-build: ## æ„å»ºç”Ÿäº§é•œåƒ (è‡ªåŠ¨åŒ…å« LibreOffice)
	@echo "$(GREEN)ğŸ—ï¸  æ„å»ºç”Ÿäº§é•œåƒ (ç‰ˆæœ¬: $(VERSION))...$(NC)"
	@echo "$(YELLOW)æ­¥éª¤ 1/3: æ„å»ºåŸºç¡€ API é•œåƒ$(NC)"
	docker build -t $(DOCKER_REGISTRY)/$(PROJECT_NAME)-api:$(VERSION)-base ./api
	@echo "$(YELLOW)æ­¥éª¤ 2/3: æ‰©å±• API é•œåƒ (æ·»åŠ  LibreOffice)$(NC)"
	docker build -t $(DOCKER_REGISTRY)/$(PROJECT_NAME)-api:$(VERSION) \
		--build-arg BASE_IMAGE=$(DOCKER_REGISTRY)/$(PROJECT_NAME)-api:$(VERSION)-base \
		-f .custom/docker/api/Dockerfile.api-custom .
	docker tag $(DOCKER_REGISTRY)/$(PROJECT_NAME)-api:$(VERSION) $(DOCKER_REGISTRY)/$(PROJECT_NAME)-api:latest
	@echo "$(YELLOW)æ­¥éª¤ 3/3: æ„å»º Web é•œåƒ$(NC)"
	docker build -t $(DOCKER_REGISTRY)/$(PROJECT_NAME)-web:$(VERSION) ./web
	docker tag $(DOCKER_REGISTRY)/$(PROJECT_NAME)-web:$(VERSION) $(DOCKER_REGISTRY)/$(PROJECT_NAME)-web:latest
	@echo "$(GREEN)âœ… ç”Ÿäº§é•œåƒæ„å»ºå®Œæˆ (å« LibreOffice)$(NC)"

prod-push: ## æ¨é€ç”Ÿäº§é•œåƒåˆ°ä»“åº“
	@echo "$(GREEN)ğŸ“¤ æ¨é€é•œåƒåˆ° $(DOCKER_REGISTRY)...$(NC)"
	docker push $(DOCKER_REGISTRY)/$(PROJECT_NAME)-api:$(VERSION)
	docker push $(DOCKER_REGISTRY)/$(PROJECT_NAME)-web:$(VERSION)
	docker push $(DOCKER_REGISTRY)/$(PROJECT_NAME)-api:latest
	docker push $(DOCKER_REGISTRY)/$(PROJECT_NAME)-web:latest
	@echo "$(GREEN)âœ… é•œåƒæ¨é€å®Œæˆ$(NC)"

prod-deploy: ## ç”Ÿäº§ç¯å¢ƒæ»šåŠ¨æ›´æ–° (éœ€åœ¨æœåŠ¡å™¨æ‰§è¡Œ)
	@echo "$(GREEN)ğŸš€ æ»šåŠ¨æ›´æ–°ç”Ÿäº§ç¯å¢ƒ...$(NC)"
	@$(MAKE) -f Makefile.custom env-merge ENV=prod
	@cd docker && docker compose -f docker-compose.yaml --env-file .env pull
	@echo "$(YELLOW)ğŸ“¦ æ›´æ–° API å®¹å™¨...$(NC)"
	@cd docker && docker compose -f docker-compose.yaml --env-file .env up -d --no-deps api
	@echo "$(YELLOW)â³ ç­‰å¾… API å¥åº·æ£€æŸ¥ (æœ€å¤š 30 ç§’)...$(NC)"
	@for i in 1 2 3 4 5 6; do \
		if cd docker && docker compose -f docker-compose.yaml exec -T api curl -sf http://localhost:5001/health > /dev/null 2>&1; then \
			echo "$(GREEN)âœ“ API å¥åº·æ£€æŸ¥é€šè¿‡$(NC)"; \
			break; \
		fi; \
		if [ $$i -eq 6 ]; then \
			echo "$(YELLOW)âš ï¸  API å¥åº·æ£€æŸ¥è¶…æ—¶ï¼Œç»§ç»­æ›´æ–° Web$(NC)"; \
		else \
			sleep 5; \
		fi; \
	done
	@echo "$(YELLOW)ğŸ“¦ æ›´æ–° Web å®¹å™¨...$(NC)"
	@cd docker && docker compose -f docker-compose.yaml --env-file .env up -d --no-deps web
	@echo "$(GREEN)âœ… ç”Ÿäº§ç¯å¢ƒæ›´æ–°å®Œæˆ$(NC)"

# ============================================================
# åŒæ­¥ä¸Šæ¸¸
# ============================================================

sync-upstream: ## åŒæ­¥å®˜æ–¹ä¸Šæ¸¸ä»£ç 
	@echo "$(GREEN)ğŸ”„ åŒæ­¥ä¸Šæ¸¸ä»£ç ...$(NC)"
	git fetch upstream
	git checkout main
	git rebase upstream/main
	git push origin main
	@echo "$(YELLOW)âš ï¸  è¯·æ‰‹åŠ¨åˆå¹¶åˆ° development: git checkout development && git rebase main$(NC)"

# ============================================================
# API è‡ªå®šä¹‰é•œåƒæ„å»º
# ============================================================
# è¯´æ˜: æ”¯æŒåŸç”Ÿæ–‡æ¡£æå– (DOC/PPT)ï¼ŒåŒ…å« LibreOffice

API_CUSTOM_IMAGE ?= dify-api-custom:latest
API_BASE_IMAGE ?= langgenius/dify-api:0.15.3

api-build: ## æ„å»ºè‡ªå®šä¹‰ API é•œåƒ (åŒ…å« LibreOffice)
	@echo "$(GREEN)ğŸ”§ æ„å»ºè‡ªå®šä¹‰ API é•œåƒ...$(NC)"
	docker build -t $(API_CUSTOM_IMAGE) \
		--build-arg BASE_IMAGE=$(API_BASE_IMAGE) \
		-f .custom/docker/api/Dockerfile.api-custom \
		.
	@echo "$(GREEN)âœ… API é•œåƒæ„å»ºå®Œæˆ: $(API_CUSTOM_IMAGE)$(NC)"
	@echo "$(YELLOW)ğŸ’¡ å¯ç”¨æ–¹æ³•: åœ¨ .custom/env/.env.custom.* ä¸­è®¾ç½® API_IMAGE=$(API_CUSTOM_IMAGE)$(NC)"

api-build-multiarch: ## æ„å»ºå¤šæ¶æ„ API é•œåƒ (AMD64 + ARM64)
	@echo "$(GREEN)ğŸ”§ æ„å»ºå¤šæ¶æ„ API é•œåƒ...$(NC)"
	docker buildx build --platform linux/amd64,linux/arm64 \
		-t $(API_CUSTOM_IMAGE) \
		--build-arg BASE_IMAGE=$(API_BASE_IMAGE) \
		-f .custom/docker/api/Dockerfile.api-custom \
		. \
		--push
	@echo "$(GREEN)âœ… å¤šæ¶æ„ API é•œåƒå·²æ¨é€: $(API_CUSTOM_IMAGE)$(NC)"

api-install-libreoffice: ## å®‰è£… LibreOffice (æœ¬åœ°å¼€å‘ç¯å¢ƒ)
	@echo "$(GREEN)ğŸ“¦ å®‰è£… LibreOffice...$(NC)"
	@if [ "$$(uname)" = "Darwin" ]; then \
		echo "$(YELLOW)æ£€æµ‹åˆ° macOSï¼Œä½¿ç”¨ Homebrew å®‰è£…...$(NC)"; \
		brew install --cask libreoffice; \
	elif [ -f /etc/debian_version ]; then \
		echo "$(YELLOW)æ£€æµ‹åˆ° Debian/Ubuntuï¼Œä½¿ç”¨ apt å®‰è£…...$(NC)"; \
		sudo apt-get update && sudo apt-get install -y libreoffice-writer-nogui libreoffice-impress-nogui fonts-liberation fonts-noto-cjk; \
	else \
		echo "$(RED)âŒ ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿï¼Œè¯·æ‰‹åŠ¨å®‰è£… LibreOffice$(NC)"; \
		exit 1; \
	fi
	@echo "$(GREEN)âœ… LibreOffice å®‰è£…å®Œæˆ$(NC)"
	@which soffice && echo "$(GREEN)âœ“ soffice è·¯å¾„: $$(which soffice)$(NC)"

api-test-extractors: ## æµ‹è¯• API é•œåƒä¸­çš„æ–‡æ¡£æå–å™¨
	@echo "$(GREEN)ğŸ§ª æµ‹è¯• API æ–‡æ¡£æå–å™¨...$(NC)"
	@CONTAINER=$$(docker ps --filter "name=api" --format "{{.Names}}" | head -1); \
	if [ -z "$$CONTAINER" ]; then \
		echo "$(RED)âŒ æœªæ‰¾åˆ° API å®¹å™¨$(NC)"; \
		exit 1; \
	fi; \
	echo "$(YELLOW)å®¹å™¨: $$CONTAINER$(NC)"; \
	echo ""; \
	echo "$(YELLOW)æµ‹è¯• LibreOffice...$(NC)"; \
	docker exec $$CONTAINER which soffice && echo "$(GREEN)âœ… LibreOffice OK$(NC)" || echo "$(RED)âŒ LibreOffice æœªå®‰è£…$(NC)"; \
	echo ""; \
	echo "$(YELLOW)æµ‹è¯• python-pptx (PPTX)...$(NC)"; \
	docker exec $$CONTAINER python -c "from pptx import Presentation; print('âœ… python-pptx OK')" 2>/dev/null || echo "$(RED)âŒ python-pptx æµ‹è¯•å¤±è´¥$(NC)"; \
	echo ""; \
	echo "$(YELLOW)æµ‹è¯• ebooklib (EPUB)...$(NC)"; \
	docker exec $$CONTAINER python -c "import ebooklib; print('âœ… ebooklib OK')" 2>/dev/null || echo "$(RED)âŒ ebooklib æµ‹è¯•å¤±è´¥$(NC)"; \
	echo ""; \
	echo "$(YELLOW)æµ‹è¯• unstructured (DOC/PPT)...$(NC)"; \
	docker exec $$CONTAINER python -c "from unstructured.partition.doc import partition_doc; print('âœ… unstructured.doc OK')" 2>/dev/null || echo "$(RED)âŒ unstructured.doc æµ‹è¯•å¤±è´¥$(NC)"

# ============================================================
# Sandbox è‡ªå®šä¹‰é•œåƒæ„å»º
# ============================================================
# è¯´æ˜: æ”¯æŒä»£ç èŠ‚ç‚¹ä½¿ç”¨ç³»ç»Ÿä¾èµ–åº“ (å¦‚ pyzbar, opencv ç­‰)
# æ–‡æ¡£: .custom/docs/migrate_docs/FORK_PRD_MIGRATION.md

SANDBOX_CUSTOM_IMAGE ?= dify-sandbox-custom:latest
SANDBOX_BASE_IMAGE ?= langgenius/dify-sandbox:0.2.12

sandbox-build: ## æ„å»ºè‡ªå®šä¹‰ Sandbox é•œåƒ (å½“å‰æ¶æ„)
	@echo "$(GREEN)ğŸ”§ æ„å»ºè‡ªå®šä¹‰ Sandbox é•œåƒ...$(NC)"
	docker build -t $(SANDBOX_CUSTOM_IMAGE) \
		--build-arg BASE_IMAGE=$(SANDBOX_BASE_IMAGE) \
		-f .custom/docker/sandbox/Dockerfile.sandbox-custom \
		.custom/docker/sandbox/
	@echo "$(GREEN)âœ… Sandbox é•œåƒæ„å»ºå®Œæˆ: $(SANDBOX_CUSTOM_IMAGE)$(NC)"
	@echo "$(YELLOW)ğŸ’¡ å¯ç”¨æ–¹æ³•: åœ¨ .custom/env/.env.custom.* ä¸­è®¾ç½® SANDBOX_IMAGE=$(SANDBOX_CUSTOM_IMAGE)$(NC)"

sandbox-build-multiarch: ## æ„å»ºå¤šæ¶æ„ Sandbox é•œåƒ (AMD64 + ARM64)
	@echo "$(GREEN)ğŸ”§ æ„å»ºå¤šæ¶æ„ Sandbox é•œåƒ...$(NC)"
	docker buildx build --platform linux/amd64,linux/arm64 \
		-t $(SANDBOX_CUSTOM_IMAGE) \
		--build-arg BASE_IMAGE=$(SANDBOX_BASE_IMAGE) \
		-f .custom/docker/sandbox/Dockerfile.sandbox-custom \
		.custom/docker/sandbox/ \
		--push
	@echo "$(GREEN)âœ… å¤šæ¶æ„ Sandbox é•œåƒå·²æ¨é€: $(SANDBOX_CUSTOM_IMAGE)$(NC)"

sandbox-rebuild: ## å¼ºåˆ¶é‡æ–°æ„å»º Sandbox é•œåƒ (ä¸ä½¿ç”¨ç¼“å­˜)
	@echo "$(GREEN)ğŸ”§ å¼ºåˆ¶é‡æ–°æ„å»º Sandbox é•œåƒ...$(NC)"
	docker build --no-cache -t $(SANDBOX_CUSTOM_IMAGE) \
		--build-arg BASE_IMAGE=$(SANDBOX_BASE_IMAGE) \
		-f .custom/docker/sandbox/Dockerfile.sandbox-custom \
		.custom/docker/sandbox/
	@echo "$(GREEN)âœ… Sandbox é•œåƒé‡æ–°æ„å»ºå®Œæˆ$(NC)"

sandbox-refresh-deps: ## åˆ·æ–° Sandbox Python ä¾èµ– (é€šè¿‡ API)
	@echo "$(GREEN)ğŸ”„ åˆ·æ–° Sandbox Python ä¾èµ–...$(NC)"
	@curl -s -X POST http://localhost:8194/v1/sandbox/dependencies/refresh \
		-H "X-Api-Key: $${SANDBOX_API_KEY:-dify-sandbox}" && echo "" || \
		echo "$(RED)âŒ åˆ·æ–°å¤±è´¥ï¼Œè¯·ç¡®ä¿ Sandbox æœåŠ¡å·²å¯åŠ¨$(NC)"

sandbox-test-deps: ## æµ‹è¯• Sandbox ä¾èµ–æ˜¯å¦æ­£å¸¸
	@echo "$(GREEN)ğŸ§ª æµ‹è¯• Sandbox ä¾èµ–...$(NC)"
	@CONTAINER=$$(docker ps --filter "name=sandbox" --format "{{.Names}}" | head -1); \
	if [ -z "$$CONTAINER" ]; then \
		echo "$(RED)âŒ æœªæ‰¾åˆ° Sandbox å®¹å™¨$(NC)"; \
		exit 1; \
	fi; \
	echo "$(YELLOW)å®¹å™¨: $$CONTAINER$(NC)"; \
	echo ""; \
	echo "$(YELLOW)æµ‹è¯• pyzbar (äºŒç»´ç è¯†åˆ«)...$(NC)"; \
	docker exec $$CONTAINER python3 -c "from pyzbar import pyzbar; print('âœ… pyzbar OK')" 2>/dev/null || echo "$(RED)âŒ pyzbar æµ‹è¯•å¤±è´¥$(NC)"; \
	echo ""; \
	echo "$(YELLOW)æµ‹è¯• pandas (æ•°æ®åˆ†æ)...$(NC)"; \
	docker exec $$CONTAINER python3 -c "import pandas; print('âœ… pandas OK')" 2>/dev/null || echo "$(RED)âŒ pandas æµ‹è¯•å¤±è´¥$(NC)"; \
	echo ""; \
	echo "$(YELLOW)æµ‹è¯• PyMuPDF (PDFå¤„ç†)...$(NC)"; \
	docker exec $$CONTAINER python3 -c "import fitz; print('âœ… PyMuPDF OK')" 2>/dev/null || echo "$(RED)âŒ PyMuPDF æµ‹è¯•å¤±è´¥$(NC)"; \
	echo ""; \
	echo "$(YELLOW)æµ‹è¯• ctypes.util.find_library...$(NC)"; \
	docker exec $$CONTAINER python3 -c "import ctypes.util; result = ctypes.util.find_library('zbar'); print(f'âœ… find_library(zbar) = {result}')" 2>/dev/null || echo "$(RED)âŒ ctypes æµ‹è¯•å¤±è´¥$(NC)"

sandbox-info: ## æŸ¥çœ‹ Sandbox å®¹å™¨ä¿¡æ¯
	@echo "$(GREEN)ğŸ“‹ Sandbox å®¹å™¨ä¿¡æ¯$(NC)"
	@echo ""
	@CONTAINER=$$(docker ps --filter "name=sandbox" --format "{{.Names}}" | head -1); \
	if [ -z "$$CONTAINER" ]; then \
		echo "$(RED)âŒ æœªæ‰¾åˆ° Sandbox å®¹å™¨$(NC)"; \
		exit 1; \
	fi; \
	echo "$(YELLOW)å®¹å™¨åç§°:$(NC) $$CONTAINER"; \
	echo "$(YELLOW)é•œåƒ:$(NC) $$(docker inspect --format='{{.Config.Image}}' $$CONTAINER)"; \
	echo "$(YELLOW)çŠ¶æ€:$(NC) $$(docker inspect --format='{{.State.Status}}' $$CONTAINER)"; \
	echo ""; \
	echo "$(YELLOW)ldconfig ç¼“å­˜ä¸­çš„ zbar åº“:$(NC)"; \
	docker exec $$CONTAINER ldconfig -p 2>/dev/null | grep zbar || echo "  æœªæ‰¾åˆ°"; \
	echo ""; \
	echo "$(YELLOW)å·²å®‰è£…çš„ Python åŒ…:$(NC)"; \
	docker exec $$CONTAINER pip3 list 2>/dev/null | grep -E "(pyzbar|Pillow|pandas|openpyxl|PyMuPDF|python-docx|xlsxwriter|pyarrow|numpy)" || echo "  æœªå®‰è£…è‡ªå®šä¹‰åŒ…"

# ============================================================
# å·¥å…·å‘½ä»¤
# ============================================================

test-custom: ## è¿è¡ŒäºŒå¼€åŠŸèƒ½æµ‹è¯•
	@echo "$(GREEN)ğŸ§ª è¿è¡ŒäºŒå¼€åŠŸèƒ½æµ‹è¯•...$(NC)"
	@if [ -d "api/tests/custom" ]; then \
		cd api && uv run pytest tests/custom/ -v --tb=short; \
	else \
		echo "$(YELLOW)âš ï¸  api/tests/custom/ ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡$(NC)"; \
	fi

db-migrate: ## æ‰§è¡Œæ•°æ®åº“è¿ç§»
	@echo "$(GREEN)ğŸ“Š æ‰§è¡Œæ•°æ®åº“è¿ç§»...$(NC)"
	cd api && uv run flask db upgrade

db-migrate-dev: ## æ‰§è¡Œæ•°æ®åº“è¿ç§» (å¼€å‘ç¯å¢ƒï¼Œè‡ªåŠ¨åˆå¹¶ç¯å¢ƒå˜é‡)
	@echo "$(GREEN)ğŸ“Š æ‰§è¡Œæ•°æ®åº“è¿ç§» (å¼€å‘ç¯å¢ƒ)...$(NC)"
	@if [ ! -f "api/.env.example" ]; then \
		echo "$(RED)âŒ api/.env.example ä¸å­˜åœ¨$(NC)"; \
		exit 1; \
	fi
	@cp api/.env.example api/.env
	@if [ -f ".custom/env/.env.custom.dev" ]; then \
		echo "" >> api/.env; \
		echo "# ====== Custom Environment Variables (dev) ======" >> api/.env; \
		cat .custom/env/.env.custom.dev >> api/.env; \
	fi
	@cd api && uv run flask db upgrade
	@echo "$(GREEN)âœ… æ•°æ®åº“è¿ç§»å®Œæˆ$(NC)"

db-backup: ## å¤‡ä»½æ•°æ®åº“
	@echo "$(GREEN)ğŸ’¾ å¤‡ä»½æ•°æ®åº“...$(NC)"
	docker exec dify-db pg_dump -U postgres dify > backup_$$(date +%Y%m%d_%H%M%S).sql
	@echo "$(GREEN)âœ… å¤‡ä»½å®Œæˆ$(NC)"

clean: ## æ¸…ç†æ„å»ºäº§ç‰©
	@echo "$(YELLOW)ğŸ§¹ æ¸…ç†ä¸­...$(NC)"
	docker image prune -f
	@echo "$(GREEN)âœ… æ¸…ç†å®Œæˆ$(NC)"

# ============================================================
# å¸®åŠ©
# ============================================================

help: ## æ˜¾ç¤ºå¸®åŠ©
	@echo "Dify äºŒæ¬¡å¼€å‘å‘½ä»¤"
	@echo ""
	@echo "$(GREEN)ğŸš€ ä¸€é”®å‘½ä»¤ (æ¨è):$(NC)"
	@grep -E '^(setup-|start-|stop-|restart-|deploy-)' $(MAKEFILE_LIST) | grep -E ':.*?##' | awk 'BEGIN {FS = ":.*?## "}; {printf "  make -f Makefile.custom %-20s %s\n", $$1, $$2}'
	@echo ""
	@echo "$(GREEN)ç¯å¢ƒå˜é‡ç®¡ç†:$(NC)"
	@grep -E '^env-' $(MAKEFILE_LIST) | grep -E ':.*?##' | awk 'BEGIN {FS = ":.*?## "}; {printf "  make -f Makefile.custom %-20s %s\n", $$1, $$2}'
	@echo ""
	@echo "$(GREEN)å¼€å‘ç¯å¢ƒ:$(NC)"
	@grep -E '^(dev-|middleware-)' $(MAKEFILE_LIST) | grep -E ':.*?##' | awk 'BEGIN {FS = ":.*?## "}; {printf "  make -f Makefile.custom %-20s %s\n", $$1, $$2}'
	@echo ""
	@echo "$(GREEN)æµ‹è¯•ç¯å¢ƒ:$(NC)"
	@grep -E '^test-' $(MAKEFILE_LIST) | grep -E ':.*?##' | awk 'BEGIN {FS = ":.*?## "}; {printf "  make -f Makefile.custom %-20s %s\n", $$1, $$2}'
	@echo ""
	@echo "$(GREEN)ç”Ÿäº§ç¯å¢ƒ:$(NC)"
	@grep -E '^prod-' $(MAKEFILE_LIST) | grep -E ':.*?##' | awk 'BEGIN {FS = ":.*?## "}; {printf "  make -f Makefile.custom %-20s %s\n", $$1, $$2}'
	@echo ""
	@echo "$(GREEN)API è‡ªå®šä¹‰é•œåƒ (DOC/PPT æ”¯æŒ):$(NC)"
	@grep -E '^api-' $(MAKEFILE_LIST) | grep -E ':.*?##' | awk 'BEGIN {FS = ":.*?## "}; {printf "  make -f Makefile.custom %-20s %s\n", $$1, $$2}'
	@echo ""
	@echo "$(GREEN)Sandbox è‡ªå®šä¹‰é•œåƒ:$(NC)"
	@grep -E '^sandbox-' $(MAKEFILE_LIST) | grep -E ':.*?##' | awk 'BEGIN {FS = ":.*?## "}; {printf "  make -f Makefile.custom %-20s %s\n", $$1, $$2}'
	@echo ""
	@echo "$(GREEN)å·¥å…·å‘½ä»¤:$(NC)"
	@grep -E '^(sync-|db-|clean|test-custom)' $(MAKEFILE_LIST) | grep -E ':.*?##' | awk 'BEGIN {FS = ":.*?## "}; {printf "  make -f Makefile.custom %-20s %s\n", $$1, $$2}'

.PHONY: setup-dev setup-test setup-prod stop-dev restart-dev start-dev start-test deploy-prod env-init env-merge dev-start dev-api dev-web dev-api-background middleware-up middleware-down test-build test-up test-down test-restart test-logs test-custom prod-build prod-push prod-deploy sync-upstream db-migrate db-migrate-dev db-backup clean help api-build api-build-multiarch api-install-libreoffice api-test-extractors sandbox-build sandbox-build-multiarch sandbox-rebuild sandbox-refresh-deps sandbox-test-deps sandbox-info
